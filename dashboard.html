<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TinyClaw ‚Äì Multi-Agent Dashboard</title>
<style>
:root {
  --bg: #f8f9fb;
  --white: #ffffff;
  --sidebar-bg: #ffffff;
  --sidebar-w: 220px;
  --border: #e5e7eb;
  --text: #111827;
  --text2: #6b7280;
  --text3: #9ca3af;
  --accent: #2563eb;
  --accent-light: #eff6ff;
  --green: #16a34a;
  --green-light: #dcfce7;
  --yellow: #d97706;
  --yellow-light: #fef3c7;
  --red: #dc2626;
  --red-light: #fee2e2;
  --purple: #7c3aed;
  --purple-light: #ede9fe;
  --orange: #ea580c;
  --shadow: 0 1px 3px rgba(0,0,0,0.08);
  --radius: 10px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif;
  background: var(--bg);
  color: var(--text);
  display: flex;
  height: 100vh;
  overflow: hidden;
  font-size: 14px;
}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
#sidebar {
  width: var(--sidebar-w);
  background: var(--sidebar-bg);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  overflow-y: auto;
}

.logo {
  padding: 20px 16px 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  border-bottom: 1px solid var(--border);
}

.logo-icon {
  width: 32px; height: 32px;
  background: linear-gradient(135deg, #f59e0b, #ef4444);
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px;
  flex-shrink: 0;
}

.logo-text h1 { font-size: 15px; font-weight: 700; }
.logo-text span { font-size: 11px; color: var(--text2); }

nav { padding: 12px 8px; flex: 1; }

.nav-section {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.6px;
  color: var(--text3);
  padding: 8px 10px 4px;
  font-weight: 600;
}

nav a {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 10px;
  border-radius: 7px;
  color: var(--text2);
  text-decoration: none;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.12s, color 0.12s;
  margin-bottom: 1px;
}

nav a .nav-left { display: flex; align-items: center; gap: 9px; }
nav a .nav-icon { font-size: 15px; width: 18px; text-align: center; }
nav a:hover { background: var(--bg); color: var(--text); }
nav a.active { background: var(--accent-light); color: var(--accent); font-weight: 600; }

.soon-badge {
  font-size: 10px;
  background: #f3f4f6;
  color: var(--text3);
  padding: 1px 6px;
  border-radius: 10px;
  font-weight: 500;
}

.sidebar-footer {
  padding: 12px 16px;
  border-top: 1px solid var(--border);
}

.sys-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  font-weight: 500;
  color: var(--text2);
}

.dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--green);
  animation: pulse 2s infinite;
}
.dot.red { background: var(--red); animation: none; }
.dot.yellow { background: var(--yellow); animation: none; }

@keyframes pulse {
  0%,100% { opacity: 1; }
  50% { opacity: 0.4; }
}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
#main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
#topbar {
  background: var(--white);
  border-bottom: 1px solid var(--border);
  padding: 0 24px;
  height: 56px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}

.topbar-left h2 { font-size: 17px; font-weight: 700; }
.topbar-left p { font-size: 12px; color: var(--text2); margin-top: 1px; }

.topbar-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.live-badge {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 5px 12px;
  border: 1px solid #bbf7d0;
  background: #f0fdf4;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  color: var(--green);
}

.search-box {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 7px 12px;
  width: 240px;
  font-size: 13px;
  color: var(--text2);
}

.avatar {
  width: 32px; height: 32px;
  border-radius: 8px;
  background: var(--accent);
  color: white;
  display: flex; align-items: center; justify-content: center;
  font-size: 13px;
  font-weight: 700;
  flex-shrink: 0;
}

.avatar.green { background: #16a34a; }
.avatar.purple { background: var(--purple); }
.avatar.orange { background: var(--orange); }
.avatar.red { background: var(--red); }

.user-chip {
  display: flex;
  align-items: center;
  gap: 8px;
}

.user-chip .name { font-size: 13px; font-weight: 600; }
.user-chip .role { font-size: 11px; color: var(--text2); }

/* ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ */
#content {
  flex: 1;
  overflow-y: auto;
  padding: 20px 24px;
}

.section { display: none; }
.section.active { display: block; }

/* ‚îÄ‚îÄ GRID ‚îÄ‚îÄ */
.grid-3 {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 16px;
  margin-bottom: 16px;
}

.grid-2 {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 16px;
}

/* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
.card {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
  margin-bottom: 16px;
}

.card-head {
  padding: 14px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
}

.card-head h3 {
  font-size: 14px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.card-head .icon { font-size: 16px; }

.card-badge {
  font-size: 11px;
  font-weight: 600;
  padding: 3px 8px;
  border-radius: 10px;
}

.card-badge.green { background: var(--green-light); color: var(--green); }
.card-badge.blue { background: var(--accent-light); color: var(--accent); }
.card-badge.yellow { background: var(--yellow-light); color: var(--yellow); }
.card-badge.red { background: var(--red-light); color: var(--red); }

/* ‚îÄ‚îÄ TASK BOARD ‚îÄ‚îÄ */
.kanban {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 16px;
  padding: 16px;
}

.kanban-col h4 {
  font-size: 12px;
  font-weight: 600;
  color: var(--text2);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.kanban-col h4 .count {
  background: var(--bg);
  border-radius: 10px;
  padding: 1px 7px;
  font-size: 11px;
  color: var(--text3);
  font-weight: 500;
}

.task-card {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 8px;
  box-shadow: var(--shadow);
}

.task-card .task-title {
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 8px;
}

.task-meta {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 11px;
  color: var(--text2);
}

.task-meta .assignee {
  display: flex;
  align-items: center;
  gap: 5px;
}

.mini-avatar {
  width: 20px; height: 20px;
  border-radius: 5px;
  background: var(--accent);
  color: white;
  display: flex; align-items: center; justify-content: center;
  font-size: 10px;
  font-weight: 700;
}

.prio {
  font-size: 10px;
  font-weight: 600;
  padding: 2px 6px;
  border-radius: 6px;
  background: var(--yellow-light);
  color: var(--yellow);
}
.prio.high { background: var(--red-light); color: var(--red); }
.prio.low { background: var(--green-light); color: var(--green); }

.kanban-empty {
  border: 2px dashed var(--border);
  border-radius: 8px;
  padding: 20px;
  text-align: center;
  color: var(--text3);
  font-size: 12px;
}

.new-task-btn {
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 7px;
  padding: 8px 16px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.15s;
}
.new-task-btn:hover { background: #1d4ed8; }

/* ‚îÄ‚îÄ AGENT CARD ‚îÄ‚îÄ */
.agent-card {
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 14px;
  margin-bottom: 10px;
}

.agent-head {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 12px;
}

.agent-info {
  display: flex;
  align-items: center;
  gap: 10px;
}

.agent-avatar-wrap { position: relative; }

.online-dot {
  position: absolute;
  bottom: -1px; right: -1px;
  width: 10px; height: 10px;
  border-radius: 50%;
  background: var(--green);
  border: 2px solid var(--white);
}
.online-dot.offline { background: var(--text3); }

.agent-name { font-size: 14px; font-weight: 600; }
.agent-role { font-size: 11px; color: var(--text2); }
.agent-model { font-size: 10px; color: var(--text3); margin-top: 1px; }

.agent-last {
  font-size: 11px;
  color: var(--text2);
  text-align: right;
}
.agent-last strong { display: block; font-size: 12px; color: var(--text); }

.agent-stats {
  display: grid;
  grid-template-columns: auto 1fr 1fr;
  gap: 8px;
  align-items: center;
}

.stat-label { font-size: 10px; color: var(--text3); margin-bottom: 2px; }
.stat-val { font-size: 18px; font-weight: 700; }

.progress-bar-wrap { }
.progress-bar-label {
  display: flex; justify-content: space-between;
  font-size: 10px; color: var(--text2); margin-bottom: 4px;
}

.progress-bar {
  height: 6px;
  background: #e5e7eb;
  border-radius: 3px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #16a34a, #4ade80);
  border-radius: 3px;
  transition: width 0.5s ease;
}

/* ‚îÄ‚îÄ CONSENSUS ‚îÄ‚îÄ */
.consensus-item {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
}
.consensus-item:last-child { border-bottom: none; }

.consensus-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 4px;
}

.consensus-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--accent);
}

.consensus-sub { font-size: 12px; color: var(--text2); }

.consensus-time { font-size: 11px; color: var(--text3); }

.consensus-score {
  font-size: 13px;
  font-weight: 700;
  color: var(--green);
}

/* ‚îÄ‚îÄ SYSTEM HEALTH ‚îÄ‚îÄ */
.health-numbers {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1px;
  background: var(--border);
  margin-bottom: 0;
}

.health-num-cell {
  background: var(--white);
  padding: 14px 16px;
}

.health-num-cell .val {
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 2px;
}

.health-num-cell .lbl {
  font-size: 11px;
  color: var(--text2);
}

.health-section-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text3);
  font-weight: 600;
  padding: 10px 16px 6px;
  border-top: 1px solid var(--border);
}

.service-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 16px;
  border-bottom: 1px solid var(--border);
}
.service-row:last-child { border-bottom: none; }

.service-left { display: flex; align-items: center; gap: 10px; }

.service-icon {
  width: 32px; height: 32px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px;
}
.service-icon.green { background: var(--green-light); }
.service-icon.yellow { background: var(--yellow-light); }
.service-icon.red { background: var(--red-light); }

.service-name { font-size: 13px; font-weight: 500; }
.service-uptime { font-size: 11px; color: var(--text2); }

.service-time { font-size: 11px; color: var(--text3); }

/* ‚îÄ‚îÄ TEAM OVERVIEW ‚îÄ‚îÄ */
.team-overview {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1px;
  background: var(--border);
}

.team-stat {
  background: var(--white);
  padding: 16px;
  text-align: center;
}

.team-stat .val { font-size: 22px; font-weight: 700; }
.team-stat .lbl { font-size: 11px; color: var(--text2); margin-top: 2px; }

/* ‚îÄ‚îÄ OBSERVATIONS / TABLE ‚îÄ‚îÄ */
table { width: 100%; border-collapse: collapse; font-size: 13px; }

th {
  text-align: left;
  padding: 10px 14px;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.4px;
  color: var(--text2);
  background: var(--bg);
  border-bottom: 1px solid var(--border);
  font-weight: 600;
}

td {
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  vertical-align: top;
}

tr:last-child td { border-bottom: none; }
tr:hover td { background: #fafafa; }

.obs-type {
  display: inline-block;
  font-size: 10px;
  font-weight: 600;
  padding: 2px 7px;
  border-radius: 8px;
  background: var(--accent-light);
  color: var(--accent);
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.trunc { max-width: 380px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.mono { font-family: monospace; font-size: 12px; }
.text-dim { color: var(--text2); }

/* ‚îÄ‚îÄ PAGINATION ‚îÄ‚îÄ */
.pag {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 14px;
  border-top: 1px solid var(--border);
  font-size: 12px;
  color: var(--text2);
}

.pag button {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 4px 10px;
  cursor: pointer;
  font-size: 12px;
  color: var(--text);
  transition: background 0.12s;
}
.pag button:hover { background: var(--bg); }
.pag button:disabled { opacity: 0.4; cursor: not-allowed; }

/* ‚îÄ‚îÄ LIVE STREAM ‚îÄ‚îÄ */
#stream-log {
  background: #0d1117;
  border-radius: 8px;
  padding: 16px;
  height: 420px;
  overflow-y: auto;
  font-family: monospace;
  font-size: 12px;
  line-height: 1.7;
}

.log-line { padding: 1px 0; }
.log-ts { color: #6b7280; margin-right: 8px; }
.log-event { color: #a78bfa; margin-right: 8px; }
.log-data { color: #e5e7eb; }

/* ‚îÄ‚îÄ LOADING / EMPTY ‚îÄ‚îÄ */
.loading, .empty {
  padding: 32px;
  text-align: center;
  color: var(--text2);
  font-size: 13px;
}

.spinner {
  display: inline-block;
  width: 14px; height: 14px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-right: 6px;
  vertical-align: middle;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ‚îÄ‚îÄ SESSION TIMELINE ‚îÄ‚îÄ */
.tl-wrap {
  position: relative;
  padding-left: 32px;
}

.tl-wrap::before {
  content: '';
  position: absolute;
  left: 11px;
  top: 0; bottom: 0;
  width: 2px;
  background: var(--border);
  border-radius: 1px;
}

.tl-item {
  position: relative;
  margin-bottom: 12px;
}

.tl-dot {
  position: absolute;
  left: -26px;
  top: 14px;
  width: 14px; height: 14px;
  border-radius: 50%;
  border: 2px solid var(--white);
  box-shadow: 0 0 0 2px var(--border);
  background: var(--white);
  z-index: 1;
}

.tl-dot.prompt  { background: var(--accent); box-shadow: 0 0 0 2px #bfdbfe; }
.tl-dot.obs     { background: var(--green);  box-shadow: 0 0 0 2px #bbf7d0; }
.tl-dot.summary { background: var(--purple); box-shadow: 0 0 0 2px #ddd6fe; }

.tl-card {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px 14px;
  box-shadow: var(--shadow);
  transition: border-color 0.15s;
}
.tl-card:hover { border-color: #93c5fd; }

.tl-card-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 6px;
  gap: 8px;
}

.tl-type-label {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 2px 7px;
  border-radius: 8px;
}
.tl-type-label.prompt  { background: #eff6ff; color: var(--accent); }
.tl-type-label.obs     { background: #f0fdf4; color: var(--green); }
.tl-type-label.summary { background: #faf5ff; color: var(--purple); }

.tl-time {
  font-size: 11px;
  color: var(--text3);
  margin-left: auto;
  white-space: nowrap;
}

.tl-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 4px;
}

.tl-body {
  font-size: 12px;
  color: var(--text2);
  line-height: 1.55;
}

.tl-expand-btn {
  font-size: 11px;
  color: var(--accent);
  cursor: pointer;
  background: none;
  border: none;
  padding: 0;
  margin-top: 4px;
  text-decoration: underline;
}

.tl-summary-card {
  background: linear-gradient(135deg, #faf5ff, #eff6ff);
  border: 1px solid #ddd6fe;
}

.tl-summary-section {
  margin-bottom: 10px;
}
.tl-summary-section h5 {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.4px;
  color: var(--text3);
  font-weight: 700;
  margin-bottom: 4px;
}

/* ‚îÄ‚îÄ HEARTBEAT ‚îÄ‚îÄ */
.hb-stats-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin-bottom: 16px;
}

.hb-stat {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px 16px;
  box-shadow: var(--shadow);
}

.hb-stat .lbl {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.4px;
  color: var(--text2);
  margin-bottom: 6px;
  font-weight: 600;
}

.hb-stat .val {
  font-size: 26px;
  font-weight: 700;
  line-height: 1;
}

.hb-stat .sub {
  font-size: 11px;
  color: var(--text2);
  margin-top: 4px;
}

.hb-chart-wrap {
  width: 100%;
  overflow-x: auto;
}

.hb-bars {
  display: flex;
  align-items: flex-end;
  gap: 2px;
  height: 80px;
  padding-bottom: 0;
}

.hb-bar-wrap {
  display: flex;
  flex-direction: column;
  align-items: center;
  flex: 1;
  min-width: 6px;
  height: 80px;
  justify-content: flex-end;
  position: relative;
  cursor: pointer;
}

.hb-bar-wrap:hover .hb-tooltip { display: block; }

.hb-bar {
  width: 100%;
  border-radius: 2px 2px 0 0;
  min-height: 2px;
  transition: opacity 0.1s;
}

.hb-bar-wrap:hover .hb-bar { opacity: 0.75; }

.hb-bar.active { background: var(--accent); }
.hb-bar.idle   { background: #e5e7eb; }
.hb-bar.busy   { background: var(--green); }

.hb-tooltip {
  display: none;
  position: absolute;
  bottom: calc(100% + 4px);
  left: 50%;
  transform: translateX(-50%);
  background: #111;
  color: #fff;
  font-size: 10px;
  padding: 3px 6px;
  border-radius: 4px;
  white-space: nowrap;
  z-index: 10;
  pointer-events: none;
}

.hb-x-labels {
  display: flex;
  justify-content: space-between;
  padding: 4px 0 0;
  font-size: 10px;
  color: var(--text3);
}

.hb-event-row {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 8px 14px;
  border-bottom: 1px solid var(--border);
  font-size: 12px;
}

.hb-event-row:last-child { border-bottom: none; }
.hb-event-row:hover { background: #fafafa; }

.hb-event-time {
  font-family: monospace;
  font-size: 11px;
  color: var(--text3);
  white-space: nowrap;
  flex-shrink: 0;
  min-width: 60px;
}

.hb-event-level {
  font-size: 10px;
  font-weight: 700;
  padding: 1px 5px;
  border-radius: 4px;
  flex-shrink: 0;
}

.hb-event-level.INFO  { background: #eff6ff; color: var(--accent); }
.hb-event-level.WARN  { background: var(--yellow-light); color: var(--yellow); }
.hb-event-level.ERROR { background: var(--red-light); color: var(--red); }
.hb-event-level.DEBUG { background: #f3f4f6; color: var(--text3); }

.hb-event-cat {
  font-size: 10px;
  font-weight: 600;
  padding: 1px 5px;
  border-radius: 4px;
  background: #f3f4f6;
  color: var(--text2);
  flex-shrink: 0;
}

.hb-event-msg {
  color: var(--text);
  flex: 1;
  font-size: 12px;
  line-height: 1.4;
}

/* ‚îÄ‚îÄ TASK MANAGER ‚îÄ‚îÄ */
.tm-board {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 16px;
  align-items: start;
}

.tm-col {
  background: var(--bg);
  border-radius: 10px;
  padding: 12px;
  min-height: 200px;
}

.tm-col-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}

.tm-col-title {
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text2);
  display: flex;
  align-items: center;
  gap: 6px;
}

.tm-col-count {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: 10px;
  font-size: 11px;
  font-weight: 600;
  padding: 1px 7px;
  color: var(--text2);
}

.tm-task {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 11px 12px;
  margin-bottom: 8px;
  box-shadow: var(--shadow);
  cursor: grab;
  transition: box-shadow 0.15s, border-color 0.15s;
  position: relative;
}

.tm-task:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-color: #93c5fd; }
.tm-task.dragging { opacity: 0.5; cursor: grabbing; }

.tm-task-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 6px;
  padding-right: 20px;
}

.tm-task-desc {
  font-size: 12px;
  color: var(--text2);
  margin-bottom: 8px;
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.tm-task-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 6px;
}

.tm-prio {
  font-size: 10px;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 5px;
}
.tm-prio.high   { background: #fef2f2; color: #dc2626; }
.tm-prio.medium { background: #fef3c7; color: #d97706; }
.tm-prio.low    { background: #f0fdf4; color: #16a34a; }

.tm-assignee {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 11px;
  color: var(--text2);
}

.tm-task-age {
  font-size: 10px;
  color: var(--text3);
  margin-left: auto;
}

.tm-delete-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  background: none;
  border: none;
  color: var(--text3);
  cursor: pointer;
  font-size: 14px;
  padding: 0;
  line-height: 1;
  display: none;
}
.tm-task:hover .tm-delete-btn { display: block; }
.tm-delete-btn:hover { color: var(--red); }

.tm-drop-zone {
  min-height: 60px;
  border: 2px dashed transparent;
  border-radius: 8px;
  transition: border-color 0.15s, background 0.15s;
}
.tm-drop-zone.drag-over {
  border-color: var(--accent);
  background: var(--accent-light);
}

/* Task form modal */
.tm-modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 200;
  align-items: center;
  justify-content: center;
}
.tm-modal-overlay.open { display: flex; }

.tm-modal {
  background: var(--white);
  border-radius: 12px;
  width: 480px;
  max-width: 95vw;
  box-shadow: 0 20px 60px rgba(0,0,0,0.2);
  overflow: hidden;
}

.tm-modal-head {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.tm-modal-head h3 { font-size: 15px; font-weight: 700; }

.tm-modal-body { padding: 20px; }

.tm-field {
  margin-bottom: 14px;
}

.tm-field label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: var(--text2);
  margin-bottom: 5px;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.tm-field input,
.tm-field textarea,
.tm-field select {
  width: 100%;
  padding: 8px 10px;
  border: 1px solid var(--border);
  border-radius: 7px;
  font-size: 13px;
  font-family: inherit;
  background: var(--white);
  color: var(--text);
  outline: none;
  transition: border-color 0.15s;
}

.tm-field input:focus,
.tm-field textarea:focus,
.tm-field select:focus { border-color: var(--accent); }

.tm-field textarea { resize: vertical; min-height: 70px; }

.tm-modal-footer {
  padding: 12px 20px;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}

.tm-btn {
  padding: 8px 16px;
  border-radius: 7px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: background 0.15s;
}
.tm-btn.primary { background: var(--accent); color: white; }
.tm-btn.primary:hover { background: #1d4ed8; }
.tm-btn.secondary { background: var(--white); color: var(--text2); border: 1px solid var(--border); }
.tm-btn.secondary:hover { background: var(--bg); }

/* Task stats bar */
.tm-stats {
  display: flex;
  gap: 20px;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  font-size: 12px;
  color: var(--text2);
}
.tm-stats strong { color: var(--text); font-size: 16px; font-weight: 700; display: block; }

/* ‚îÄ‚îÄ AGENT DRAWER ‚îÄ‚îÄ */
.agent-drawer-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.3);
  z-index: 300;
}
.agent-drawer-overlay.open { display: block; }

.agent-drawer {
  position: fixed;
  top: 0; right: 0; bottom: 0;
  width: 520px;
  max-width: 95vw;
  background: var(--white);
  border-left: 1px solid var(--border);
  box-shadow: -8px 0 30px rgba(0,0,0,0.12);
  display: flex;
  flex-direction: column;
  z-index: 301;
  transform: translateX(100%);
  transition: transform 0.25s cubic-bezier(0.4,0,0.2,1);
}
.agent-drawer-overlay.open .agent-drawer {
  transform: translateX(0);
}

.drawer-head {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
}
.drawer-head .avatar { width: 40px; height: 40px; font-size: 16px; border-radius: 10px; }
.drawer-head-info { flex: 1; }
.drawer-head-info h3 { font-size: 16px; font-weight: 700; }
.drawer-head-info p { font-size: 12px; color: var(--text2); margin-top: 2px; }
.drawer-close { background: none; border: none; font-size: 22px; cursor: pointer; color: var(--text2); padding: 0; line-height: 1; }
.drawer-close:hover { color: var(--text); }

.drawer-tabs { display: flex; border-bottom: 1px solid var(--border); flex-shrink: 0; }
.drawer-tab { padding: 10px 16px; font-size: 13px; font-weight: 500; color: var(--text2); cursor: pointer; border-bottom: 2px solid transparent; transition: color 0.12s, border-color 0.12s; }
.drawer-tab:hover { color: var(--text); }
.drawer-tab.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 600; }

.drawer-body { flex: 1; overflow-y: auto; padding: 16px 20px; }

.file-list { display: flex; flex-direction: column; gap: 8px; }

.file-item {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 12px;
  border: 1px solid var(--border); border-radius: 8px;
  cursor: pointer; transition: background 0.12s, border-color 0.12s;
}
.file-item:hover { background: var(--bg); border-color: var(--accent); }

.file-icon { font-size: 18px; flex-shrink: 0; }
.file-name { font-size: 13px; font-weight: 600; flex: 1; }
.file-size { font-size: 11px; color: var(--text3); }

.file-content-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
.file-content-head h4 { font-size: 13px; font-weight: 600; }
.file-content-back { font-size: 12px; color: var(--accent); cursor: pointer; background: none; border: none; padding: 0; text-decoration: underline; }
.file-content-body {
  background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
  padding: 14px; font-size: 12px; line-height: 1.65;
  white-space: pre-wrap; word-break: break-word;
  max-height: calc(100vh - 280px); overflow-y: auto;
  font-family: monospace; color: var(--text);
}

/* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="sidebar">
  <div class="logo">
    <div class="logo-icon">‚ö°</div>
    <div class="logo-text">
      <h1>TinyClaw</h1>
      <span>Multi-Agent Orchestration</span>
    </div>
  </div>

  <nav>
    <a class="active" data-section="dashboard">
      <span class="nav-left"><span class="nav-icon">‚äû</span> Dashboard</span>
    </a>
    <a data-section="taskboard">
      <span class="nav-left"><span class="nav-icon">‚úì</span> Task Boards</span>
    </a>
    <a data-section="agents">
      <span class="nav-left"><span class="nav-icon">üë§</span> Agents</span>
    </a>
    <a data-section="observations">
      <span class="nav-left"><span class="nav-icon">üîç</span> Memory</span>
    </a>
    <a data-section="timeline">
      <span class="nav-left"><span class="nav-icon">üïê</span> Session Timeline</span>
    </a>
    <a>
      <span class="nav-left"><span class="nav-icon">üí¨</span> Message Queues</span>
      <span class="soon-badge">Soon</span>
    </a>
    <a>
      <span class="nav-left"><span class="nav-icon">üîÄ</span> Consensus Log</span>
      <span class="soon-badge">Soon</span>
    </a>
    <a data-section="heartbeat">
      <span class="nav-left"><span class="nav-icon">‚ô°</span> Heartbeat</span>
    </a>
    <a>
      <span class="nav-left"><span class="nav-icon">üìÅ</span> File Exchange</span>
      <span class="soon-badge">Soon</span>
    </a>
    <a data-section="stream">
      <span class="nav-left"><span class="nav-icon">üì°</span> Activity Log</span>
    </a>
  </nav>

  <div class="sidebar-footer">
    <div class="sys-status">
      <div class="dot" id="sys-dot"></div>
      <span id="sys-label">All systems operational</span>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="main">

  <!-- TOPBAR -->
  <div id="topbar">
    <div class="topbar-left">
      <h2 id="page-title">Multi-Agent Dashboard</h2>
      <p id="page-sub">Monitor and orchestrate your TinyClaw agent team</p>
    </div>
    <div class="topbar-right">
      <div class="live-badge">
        <div class="dot" id="live-dot"></div>
        <span id="live-label">Live</span>
      </div>
      <div class="search-box">üîç Search tasks, agents, messages...</div>
      <div style="font-size:20px;color:var(--text2);cursor:pointer">üîî</div>
      <div class="user-chip">
        <div class="avatar" id="user-avatar">T</div>
        <div>
          <div class="name" id="user-name">Tinyboy</div>
          <div class="role">Agent</div>
        </div>
      </div>
    </div>
  </div>

  <!-- CONTENT -->
  <div id="content">

    <!-- ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ -->
    <div id="section-dashboard" class="section active">

      <!-- Task Board preview -->
      <div class="card">
        <div class="card-head">
          <h3><span class="icon">‚úì</span> Task Board <span style="font-weight:400;color:var(--text2);font-size:12px">Track and manage agent tasks</span></h3>
          <button class="new-task-btn" onclick="openTmModal()">+ New Task</button>
        </div>
        <div class="kanban" id="kanban-preview">
          <div class="loading"><span class="spinner"></span>Loading...</div>
        </div>
      </div>

      <div class="grid-3">
        <!-- Agent Performance -->
        <div class="card" style="margin-bottom:0">
          <div class="card-head">
            <h3><span class="icon">üë•</span> Agent Performance</h3>
            <span class="card-badge green">‚ñ≤ Live</span>
          </div>
          <div style="padding:12px" id="agent-cards">
            <div class="loading"><span class="spinner"></span>Loading...</div>
          </div>
          <div class="team-overview" id="team-overview"></div>
        </div>

        <!-- Consensus Protocol -->
        <div class="card" style="margin-bottom:0">
          <div class="card-head">
            <h3><span class="icon">üîÄ</span> Consensus Protocol</h3>
            <span class="card-badge blue">Active</span>
          </div>
          <div id="consensus-body">
            <div class="loading"><span class="spinner"></span>Loading...</div>
          </div>
        </div>

        <!-- System Health -->
        <div class="card" style="margin-bottom:0">
          <div class="card-head">
            <h3><span class="icon">‚ô°</span> System Health</h3>
            <span class="card-badge" id="health-badge">‚Äî</span>
          </div>
          <div id="health-body">
            <div class="loading"><span class="spinner"></span>Loading...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ TASK MANAGER ‚îÄ‚îÄ -->
    <div id="section-taskboard" class="section">

      <!-- Board header -->
      <div class="card" style="margin-bottom:16px">
        <div class="tm-stats" id="tm-stats">
          <div><strong id="tm-total">0</strong>Total</div>
          <div><strong id="tm-inbox-count">0</strong>Inbox</div>
          <div><strong id="tm-prog-count">0</strong>In Progress</div>
          <div><strong id="tm-done-count">0</strong>Done</div>
        </div>
        <div style="padding:10px 16px;display:flex;gap:8px;align-items:center">
          <input id="tm-search" type="text" placeholder="üîç Filter tasks..." oninput="renderBoard()"
            style="flex:1;padding:7px 10px;border:1px solid var(--border);border-radius:7px;font-size:13px;outline:none;background:var(--bg)">
          <select id="tm-filter-prio" onchange="renderBoard()"
            style="padding:7px 10px;border:1px solid var(--border);border-radius:7px;font-size:13px;background:var(--white);outline:none;cursor:pointer">
            <option value="">All priorities</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
          <select id="tm-filter-agent" onchange="renderBoard()"
            style="padding:7px 10px;border:1px solid var(--border);border-radius:7px;font-size:13px;background:var(--white);outline:none;cursor:pointer">
            <option value="">All agents</option>
          </select>
          <button class="new-task-btn" onclick="openTmModal()">+ New Task</button>
        </div>
      </div>

      <!-- Kanban board -->
      <div class="tm-board">
        <div class="tm-col">
          <div class="tm-col-head">
            <div class="tm-col-title"><span>üì•</span> Inbox <span class="tm-col-count" id="cnt-inbox">0</span></div>
          </div>
          <div class="tm-drop-zone" id="col-inbox" ondragover="tmDragOver(event,'inbox')" ondragleave="tmDragLeave(event)" ondrop="tmDrop(event,'inbox')"></div>
        </div>
        <div class="tm-col">
          <div class="tm-col-head">
            <div class="tm-col-title"><span>‚ö°</span> In Progress <span class="tm-col-count" id="cnt-inprogress">0</span></div>
          </div>
          <div class="tm-drop-zone" id="col-inprogress" ondragover="tmDragOver(event,'inprogress')" ondragleave="tmDragLeave(event)" ondrop="tmDrop(event,'inprogress')"></div>
        </div>
        <div class="tm-col">
          <div class="tm-col-head">
            <div class="tm-col-title"><span>‚úÖ</span> Done <span class="tm-col-count" id="cnt-done">0</span></div>
          </div>
          <div class="tm-drop-zone" id="col-done" ondragover="tmDragOver(event,'done')" ondragleave="tmDragLeave(event)" ondrop="tmDrop(event,'done')"></div>
        </div>
      </div>

    </div>

    <!-- ‚îÄ‚îÄ AGENTS ‚îÄ‚îÄ -->
    <div id="section-agents" class="section">
      <div class="card">
        <div class="card-head"><h3>All Agents</h3></div>
        <div style="padding:16px" id="agents-full">
          <div class="loading"><span class="spinner"></span>Loading...</div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ MEMORY / OBSERVATIONS ‚îÄ‚îÄ -->
    <div id="section-observations" class="section">

      <!-- Search & Filters -->
      <div class="card" style="margin-bottom:12px">
        <div style="padding:12px 16px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <div style="flex:1;min-width:200px;position:relative">
            <span style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text3);font-size:14px">üîç</span>
            <input id="obs-search" type="text" placeholder="Search title, subtitle, narrative..."
              style="width:100%;padding:8px 12px 8px 32px;border:1px solid var(--border);border-radius:7px;font-size:13px;outline:none;background:var(--bg)"
              oninput="obsSearchDebounce()">
          </div>
          <select id="obs-type-filter" onchange="loadObs(0)"
            style="padding:8px 10px;border:1px solid var(--border);border-radius:7px;font-size:13px;background:var(--white);color:var(--text);cursor:pointer;outline:none">
            <option value="">All types</option>
            <option value="discovery">discovery</option>
            <option value="feature">feature</option>
            <option value="bugfix">bugfix</option>
            <option value="decision">decision</option>
            <option value="pattern">pattern</option>
            <option value="problem-solution">problem-solution</option>
          </select>
          <select id="obs-project-filter" onchange="loadObs(0)"
            style="padding:8px 10px;border:1px solid var(--border);border-radius:7px;font-size:13px;background:var(--white);color:var(--text);cursor:pointer;outline:none">
            <option value="">All projects</option>
          </select>
          <button onclick="loadObs(0)" style="padding:8px 14px;background:var(--accent);color:white;border:none;border-radius:7px;font-size:13px;font-weight:600;cursor:pointer">Search</button>
          <button onclick="clearObsFilters()" style="padding:8px 14px;background:var(--white);color:var(--text2);border:1px solid var(--border);border-radius:7px;font-size:13px;cursor:pointer">Clear</button>
          <span id="obs-count" style="font-size:12px;color:var(--text2);margin-left:4px"></span>
        </div>
      </div>

      <!-- Results -->
      <div class="card">
        <div id="obs-table-wrap">
          <div class="loading"><span class="spinner"></span>Loading...</div>
        </div>
        <div class="pag" id="obs-pag"></div>
      </div>

      <!-- Detail modal -->
      <div id="obs-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:100;display:none;align-items:center;justify-content:center">
        <div style="background:var(--white);border-radius:12px;max-width:680px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.2)">
          <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
            <h3 style="font-size:15px" id="modal-title">‚Äî</h3>
            <button onclick="closeModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--text2)">√ó</button>
          </div>
          <div style="padding:20px" id="modal-body"></div>
        </div>
      </div>

    </div>

    <!-- ‚îÄ‚îÄ SESSION TIMELINE ‚îÄ‚îÄ -->
    <div id="section-timeline" class="section">

      <!-- Session selector -->
      <div class="card" style="margin-bottom:12px">
        <div style="padding:12px 16px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <label style="font-size:13px;font-weight:500;color:var(--text2);white-space:nowrap">Session:</label>
          <select id="tl-session-select" onchange="loadTimeline(this.value)"
            style="flex:1;max-width:480px;padding:8px 10px;border:1px solid var(--border);border-radius:7px;font-size:12px;font-family:monospace;background:var(--white);color:var(--text);cursor:pointer;outline:none">
            <option value="">‚Äî select a session ‚Äî</option>
          </select>
          <span id="tl-meta" style="font-size:12px;color:var(--text2)"></span>
        </div>
      </div>

      <!-- Timeline -->
      <div id="tl-content">
        <div class="empty" style="padding:60px">Select a session above to view its timeline</div>
      </div>

    </div>

    <!-- ‚îÄ‚îÄ HEARTBEAT MONITOR ‚îÄ‚îÄ -->
    <div id="section-heartbeat" class="section">

      <!-- Stats row -->
      <div class="hb-stats-row" id="hb-stats">
        <div class="loading"><span class="spinner"></span>Loading...</div>
      </div>

      <!-- Activity chart -->
      <div class="card" style="margin-bottom:16px">
        <div class="card-head">
          <h3><span class="icon">üìà</span> Activity ‚Äî requests per minute</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="hb-window" onchange="loadHeartbeat()" style="padding:4px 8px;border:1px solid var(--border);border-radius:6px;font-size:12px;background:var(--white);outline:none">
              <option value="60">Last 60 min</option>
              <option value="30" selected>Last 30 min</option>
              <option value="15">Last 15 min</option>
            </select>
            <button onclick="loadHeartbeat()" style="padding:4px 10px;border:1px solid var(--border);border-radius:6px;font-size:12px;background:var(--white);cursor:pointer">‚Üª</button>
          </div>
        </div>
        <div style="padding:16px 16px 8px" id="hb-chart">
          <div class="loading"><span class="spinner"></span></div>
        </div>
      </div>

      <!-- Event log -->
      <div class="card">
        <div class="card-head">
          <h3><span class="icon">üìã</span> Recent Events</h3>
          <span id="hb-event-count" class="card-badge blue">‚Äî</span>
        </div>
        <div id="hb-log">
          <div class="loading"><span class="spinner"></span>Loading...</div>
        </div>
      </div>

    </div>

    <!-- ‚îÄ‚îÄ ACTIVITY LOG / STREAM ‚îÄ‚îÄ -->
    <div id="section-stream" class="section">
      <div class="card">
        <div class="card-head">
          <h3>Activity Log ‚Äî Live Stream</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <span class="card-badge green" id="stream-badge">‚óè Connected</span>
            <button class="pag button" style="border:1px solid var(--border);border-radius:6px;padding:4px 10px;cursor:pointer;background:var(--white);font-size:12px" onclick="clearLog()">Clear</button>
          </div>
        </div>
        <div style="padding:16px">
          <div id="stream-log"><div class="empty" style="color:#6b7280">Waiting for events...</div></div>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->

<script>
const API = window.location.origin + '/mem';
let currentSection = 'dashboard';
let obsPage = 0;
const OBS_PER = 20;
let sse = null;

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('nav a[data-section]').forEach(a => {
  a.addEventListener('click', () => {
    document.querySelectorAll('nav a').forEach(x => x.classList.remove('active'));
    a.classList.add('active');
    currentSection = a.dataset.section;
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('section-' + currentSection).classList.add('active');

    const titles = {
      dashboard: ['Multi-Agent Dashboard', 'Monitor and orchestrate your TinyClaw agent team'],
      taskboard: ['Task Manager', 'Create, assign and track tasks for your agents'],
      agents: ['Agents', 'View and manage your AI agent team'],
      observations: ['Memory Store', 'Browse persistent agent memory and observations'],
      timeline: ['Session Timeline', 'Chronological view of prompts, observations and summaries per session'],
      heartbeat: ['Heartbeat Monitor', 'Agent activity history and request frequency chart'],
      stream: ['Activity Log', 'Real-time event stream from the worker service'],
    };
    const t = titles[currentSection] || ['TinyClaw', ''];
    document.getElementById('page-title').textContent = t[0];
    document.getElementById('page-sub').textContent = t[1];

    loadSection(currentSection);
  });
});

function loadSection(sec) {
  if (sec === 'dashboard') loadDashboard();
  else if (sec === 'taskboard') loadTaskManager();
  else if (sec === 'agents') loadAgentsFull();
  else if (sec === 'observations') { populateProjectFilter(); loadObs(0); }
  else if (sec === 'timeline') loadTimelineSessions();
  else if (sec === 'heartbeat') loadHeartbeat();
  else if (sec === 'stream') ensureStream();
}

// ‚îÄ‚îÄ HEALTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function checkHealth() {
  try {
    const r = await fetch(API + '/health', { signal: AbortSignal.timeout(3000) });
    const d = await r.json();
    setLive(true, d);
  } catch {
    setLive(false, null);
  }
}

function setLive(ok, data) {
  document.getElementById('live-dot').className = ok ? 'dot' : 'dot red';
  document.getElementById('live-label').textContent = ok ? 'Live' : 'Offline';
  document.getElementById('sys-dot').className = ok ? 'dot' : 'dot red';
  document.getElementById('sys-label').textContent = ok ? 'All systems operational' : 'Worker offline';
}

// ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadDashboard() {
  await Promise.all([
    loadKanban(),
    loadAgentCards(),
    loadConsensus(),
    loadHealth(),
  ]);
}

// ‚îÄ‚îÄ TASK MANAGER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TASKS_API = window.location.origin + '/tasks';
let tmTasks = [];
let tmDraggingId = null;
let tmAgents = ['tinyboy'];

// ‚îÄ‚îÄ TASKS SSE (live updates) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let tasksSse = null;

function startTasksStream() {
  if (tasksSse) return;
  tasksSse = new EventSource(window.location.origin + '/tasks/stream');
  tasksSse.onmessage = (e) => {
    try {
      tmTasks = JSON.parse(e.data);
      // Silently re-render without a full fetch
      renderBoard(true);
      // Also update dashboard kanban preview
      const cols = { inbox: [], inprogress: [], done: [] };
      tmTasks.forEach(t => { if (cols[t.status]) cols[t.status].push(t); });
      updateDashboardKanban(cols);
    } catch {}
  };
  tasksSse.onerror = () => {
    tasksSse.close();
    tasksSse = null;
    // Retry after 5s
    setTimeout(startTasksStream, 5000);
  };
}

async function tmFetch() {
  const r = await fetch(TASKS_API);
  tmTasks = await r.json();
}

async function loadTaskManager() {
  try {
    const r = await fetch(`${API}/api/projects`);
    const d = await r.json();
    tmAgents = (Array.isArray(d) ? d : (d.projects || ['tinyboy']))
      .map(p => typeof p === 'string' ? p : p.project);
  } catch {}
  populateTmAgentDropdowns();
  await renderBoard();
}

function populateTmAgentDropdowns() {
  ['tm-agent', 'tm-filter-agent'].forEach(selId => {
    const sel = document.getElementById(selId);
    if (!sel) return;
    const isFilter = selId === 'tm-filter-agent';
    sel.innerHTML = isFilter ? '<option value="">All agents</option>' : '<option value="unassigned">Unassigned</option>';
    tmAgents.forEach(a => {
      const opt = document.createElement('option');
      opt.value = a; opt.textContent = a;
      sel.appendChild(opt);
    });
  });
}

async function renderBoard(skipFetch = false) {
  if (!skipFetch) { try { await tmFetch(); } catch { /* offline */ } }

  const q = (document.getElementById('tm-search')?.value || '').toLowerCase();
  const filterPrio = document.getElementById('tm-filter-prio')?.value || '';
  const filterAgent = document.getElementById('tm-filter-agent')?.value || '';

  const filtered = tmTasks.filter(t => {
    if (q && !(t.title.toLowerCase().includes(q) || (t.description||'').toLowerCase().includes(q))) return false;
    if (filterPrio && t.priority !== filterPrio) return false;
    if (filterAgent && t.agent !== filterAgent) return false;
    return true;
  });

  const cols = { inbox: [], inprogress: [], done: [] };
  filtered.forEach(t => { if (cols[t.status]) cols[t.status].push(t); });

  document.getElementById('tm-total').textContent = tmTasks.length;
  document.getElementById('tm-inbox-count').textContent = tmTasks.filter(t => t.status === 'inbox').length;
  document.getElementById('tm-prog-count').textContent = tmTasks.filter(t => t.status === 'inprogress').length;
  document.getElementById('tm-done-count').textContent = tmTasks.filter(t => t.status === 'done').length;
  document.getElementById('cnt-inbox').textContent = cols.inbox.length;
  document.getElementById('cnt-inprogress').textContent = cols.inprogress.length;
  document.getElementById('cnt-done').textContent = cols.done.length;

  Object.entries(cols).forEach(([status, items]) => {
    const col = document.getElementById('col-' + status);
    if (!col) return;
    col.innerHTML = items.length
      ? items.map(t => tmTaskHTML(t)).join('')
      : `<div style="text-align:center;padding:24px 12px;color:var(--text3);font-size:12px;border:2px dashed var(--border);border-radius:8px">Drop tasks here</div>`;
  });

  updateDashboardKanban(cols);
}

function updateDashboardKanban(cols) {
  const el = document.getElementById('kanban-preview');
  if (!el) return;
  el.innerHTML = `
    <div class="kanban-col">
      <h4>Inbox <span class="count">${cols.inbox.length}</span></h4>
      ${cols.inbox.slice(0,3).map(t => miniTaskCard(t)).join('') || '<div class="kanban-empty">No pending tasks</div>'}
    </div>
    <div class="kanban-col">
      <h4>In Progress <span class="count">${cols.inprogress.length}</span></h4>
      ${cols.inprogress.slice(0,3).map(t => miniTaskCard(t)).join('') || '<div class="kanban-empty">No active tasks</div>'}
    </div>
    <div class="kanban-col">
      <h4>Done <span class="count">${cols.done.length}</span></h4>
      ${cols.done.slice(0,3).map(t => miniTaskCard(t)).join('') || '<div class="kanban-empty">Nothing yet</div>'}
    </div>
  `;
}

function miniTaskCard(t) {
  const initial = (t.agent || 'U')[0].toUpperCase();
  return `
    <div class="task-card">
      <div class="task-title">${esc(t.title)}</div>
      <div class="task-meta">
        <div class="assignee"><div class="mini-avatar">${initial}</div><span>${esc(t.agent || 'unassigned')}</span></div>
        <span class="prio ${t.priority === 'high' ? 'high' : t.priority === 'low' ? 'low' : ''}">${t.priority || 'medium'}</span>
        <span>${fmtAge(t.created_at)}</span>
      </div>
    </div>`;
}

function tmTaskHTML(t) {
  const initial = (t.agent || 'U')[0].toUpperCase();
  const colors = { tinyboy: 'var(--accent)', coder: 'var(--green)', researcher: 'var(--purple)', copywriter: 'var(--orange)' };
  const avatarBg = colors[t.agent] || 'var(--accent)';
  const srcBadge = t.source && t.source !== 'dashboard'
    ? `<span style="font-size:9px;padding:1px 5px;background:#f3f4f6;color:var(--text3);border-radius:4px">${esc(t.source)}</span>`
    : '';
  return `
    <div class="tm-task" draggable="true" data-id="${t.id}"
      ondragstart="tmDragStart(event,'${t.id}')"
      ondragend="tmDragEnd(event)">
      <button class="tm-delete-btn" onclick="tmDelete('${t.id}')" title="Delete">√ó</button>
      <div class="tm-task-title">${esc(t.title)} ${srcBadge}</div>
      ${t.description ? `<div class="tm-task-desc">${esc(t.description)}</div>` : ''}
      <div class="tm-task-footer">
        <span class="tm-prio ${t.priority || 'medium'}">${t.priority || 'medium'}</span>
        <div class="tm-assignee">
          <div class="mini-avatar" style="background:${avatarBg}">${initial}</div>
          <span>${esc(t.agent || 'unassigned')}</span>
        </div>
        <span class="tm-task-age">${fmtAge(t.created_at)}</span>
        <button onclick="openTmModal('${t.id}')" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:12px;padding:0" title="Edit">‚úè</button>
      </div>
    </div>`;
}

// ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ
function openTmModal(editId) {
  const modal = document.getElementById('tm-modal');
  const titleEl = document.getElementById('tm-modal-title');

  if (editId) {
    const t = tmTasks.find(x => x.id === editId);
    if (!t) return;
    document.getElementById('tm-edit-id').value = t.id;
    document.getElementById('tm-title').value = t.title;
    document.getElementById('tm-desc').value = t.description || '';
    document.getElementById('tm-prio').value = t.priority || 'medium';
    document.getElementById('tm-agent').value = t.agent || 'unassigned';
    document.getElementById('tm-status').value = t.status;
    titleEl.textContent = 'Edit Task';
  } else {
    document.getElementById('tm-edit-id').value = '';
    document.getElementById('tm-title').value = '';
    document.getElementById('tm-desc').value = '';
    document.getElementById('tm-prio').value = 'medium';
    document.getElementById('tm-agent').value = tmAgents[0] || 'unassigned';
    document.getElementById('tm-status').value = 'inbox';
    titleEl.textContent = 'New Task';
  }

  modal.classList.add('open');
  document.getElementById('tm-title').focus();
}

function closeTmModal() {
  document.getElementById('tm-modal').classList.remove('open');
}

async function saveTmTask() {
  const title = document.getElementById('tm-title').value.trim();
  if (!title) { document.getElementById('tm-title').focus(); return; }

  const editId = document.getElementById('tm-edit-id').value;
  const payload = {
    title,
    description: document.getElementById('tm-desc').value.trim(),
    priority:    document.getElementById('tm-prio').value,
    agent:       document.getElementById('tm-agent').value,
    status:      document.getElementById('tm-status').value,
  };

  try {
    if (editId) {
      await fetch(`${TASKS_API}/${editId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    } else {
      await fetch(TASKS_API, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    }
  } catch (e) { alert('Save failed: ' + e.message); return; }

  closeTmModal();
  await renderBoard();
}

async function tmDelete(id) {
  if (!confirm('Delete this task?')) return;
  await fetch(`${TASKS_API}/${id}`, { method: 'DELETE' });
  await renderBoard();
}

// ‚îÄ‚îÄ DRAG & DROP ‚îÄ‚îÄ
function tmDragStart(e, id) {
  tmDraggingId = id;
  e.dataTransfer.effectAllowed = 'move';
  setTimeout(() => e.target.classList.add('dragging'), 0);
}

function tmDragEnd(e) {
  e.target.classList.remove('dragging');
  document.querySelectorAll('.tm-drop-zone').forEach(z => z.classList.remove('drag-over'));
}

function tmDragOver(e, status) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  document.querySelectorAll('.tm-drop-zone').forEach(z => z.classList.remove('drag-over'));
  document.getElementById('col-' + status)?.classList.add('drag-over');
}

function tmDragLeave(e) {
  if (!e.currentTarget.contains(e.relatedTarget)) e.currentTarget.classList.remove('drag-over');
}

async function tmDrop(e, status) {
  e.preventDefault();
  document.querySelectorAll('.tm-drop-zone').forEach(z => z.classList.remove('drag-over'));
  if (!tmDraggingId) return;
  const task = tmTasks.find(t => t.id === tmDraggingId);
  if (task && task.status !== status) {
    await fetch(`${TASKS_API}/${tmDraggingId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status }),
    });
    await renderBoard();
  }
  tmDraggingId = null;
}

// Kanban preview (dashboard section)
async function loadKanban() {
  try { await tmFetch(); } catch {}
  const cols = { inbox: [], inprogress: [], done: [] };
  tmTasks.forEach(t => { if (cols[t.status]) cols[t.status].push(t); });
  updateDashboardKanban(cols);
}

// ‚îÄ‚îÄ AGENT DRAWER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let drawerAgent = null;
let drawerAgentData = null;
let drawerCurrentTab = 'files';

async function openAgentDrawer(agentName) {
  drawerAgent = agentName;
  drawerCurrentTab = 'files';
  const overlay = document.getElementById('agent-drawer-overlay');
  const colors = { tinyboy: 'blue', coder: 'green', researcher: 'purple', copywriter: 'orange', 'business-coach': 'red' };
  const avatarEl = document.getElementById('drawer-avatar');
  avatarEl.textContent = agentName[0].toUpperCase();
  avatarEl.className = 'avatar ' + (colors[agentName] || 'blue');
  document.getElementById('drawer-agent-name').textContent = agentName;
  document.getElementById('drawer-agent-path').textContent = `~/tinyclaw-workspace/${agentName}`;
  document.querySelectorAll('.drawer-tab').forEach((t, i) => t.classList.toggle('active', i === 0));
  overlay.classList.add('open');
  await loadDrawerFiles();
}

function closeAgentDrawer(e) {
  if (e && e.target !== document.getElementById('agent-drawer-overlay')) return;
  document.getElementById('agent-drawer-overlay').classList.remove('open');
  drawerAgent = null;
  drawerAgentData = null;
}

function drawerTab(tab) {
  drawerCurrentTab = tab;
  document.querySelectorAll('.drawer-tab').forEach(t => t.classList.toggle('active', t.textContent.includes(tab === 'files' ? 'Files' : 'Tasks')));
  if (tab === 'files') loadDrawerFiles();
  else loadDrawerTasks();
}

async function loadDrawerFiles() {
  const body = document.getElementById('drawer-body');
  body.innerHTML = '<div class="loading"><span class="spinner"></span>Loading...</div>';
  try {
    if (!drawerAgentData) {
      const r = await fetch(window.location.origin + '/agents');
      const agents = await r.json();
      drawerAgentData = agents.find(a => a.name === drawerAgent);
    }
    if (!drawerAgentData?.files?.length) {
      body.innerHTML = '<div class="empty">No files found</div>';
      return;
    }
    renderFileList(drawerAgentData.files);
  } catch (e) {
    body.innerHTML = `<div class="empty">Error: ${e.message}</div>`;
  }
}

function renderFileList(files) {
  const body = document.getElementById('drawer-body');
  const icons = { 'AGENTS.md': 'ü§ñ', 'SOUL.md': 'üíú', 'IDENTITY.md': 'ü™™', 'CLAUDE.md': '‚öôÔ∏è', 'heartbeat.md': '‚ô°', 'dashboard.html': 'üìä', 'serve.ts': 'üñ•Ô∏è' };
  body.innerHTML = `<div class="file-list">${files.map(f => `
    <div class="file-item" onclick="openDrawerFile('${esc(f.name)}')">
      <span class="file-icon">${icons[f.name] || (f.name.endsWith('.md') ? 'üìÑ' : f.name.endsWith('.ts') || f.name.endsWith('.js') ? 'üìú' : 'üìÅ')}</span>
      <span class="file-name">${esc(f.name)}</span>
      <span class="file-size">${formatBytes(f.size)}</span>
      <span style="color:var(--text3);font-size:14px">‚Ä∫</span>
    </div>
  `).join('')}</div>`;
}

async function openDrawerFile(fileName) {
  const body = document.getElementById('drawer-body');
  body.innerHTML = '<div class="loading"><span class="spinner"></span>Loading...</div>';
  try {
    const r = await fetch(`${window.location.origin}/agents/${drawerAgent}/files/${encodeURIComponent(fileName)}`);
    if (!r.ok) throw new Error('File not found');
    const { content } = await r.json();
    body.innerHTML = `
      <div class="file-content-head">
        <h4>${icons(fileName)} ${esc(fileName)}</h4>
        <button class="file-content-back" onclick="loadDrawerFiles()">‚Üê Back to files</button>
      </div>
      <div class="file-content-body">${esc(content)}</div>
    `;
  } catch (e) {
    body.innerHTML = `<div class="empty">Error: ${e.message}</div>`;
  }
}

function icons(name) {
  const map = { 'AGENTS.md': 'ü§ñ', 'SOUL.md': 'üíú', 'IDENTITY.md': 'ü™™', 'CLAUDE.md': '‚öôÔ∏è', 'heartbeat.md': '‚ô°', 'dashboard.html': 'üìä', 'serve.ts': 'üñ•Ô∏è' };
  return map[name] || (name.endsWith('.md') ? 'üìÑ' : name.endsWith('.ts') || name.endsWith('.js') ? 'üìú' : 'üìÅ');
}

async function loadDrawerTasks() {
  const body = document.getElementById('drawer-body');
  body.innerHTML = '<div class="loading"><span class="spinner"></span>Loading...</div>';
  try {
    const r = await fetch(`${window.location.origin}/tasks?agent=${encodeURIComponent(drawerAgent)}`);
    const tasks = await r.json();
    if (!tasks.length) {
      body.innerHTML = `<div class="empty">No tasks assigned to ${drawerAgent}</div>`;
      return;
    }
    const cols = { inbox: [], inprogress: [], done: [] };
    tasks.forEach(t => { if (cols[t.status]) cols[t.status].push(t); });
    body.innerHTML = Object.entries(cols).map(([status, items]) => items.length ? `
      <div style="margin-bottom:16px">
        <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.4px;color:var(--text2);margin-bottom:8px">
          ${status === 'inbox' ? 'üì• Inbox' : status === 'inprogress' ? '‚ö° In Progress' : '‚úÖ Done'} (${items.length})
        </div>
        ${items.map(t => `
          <div style="background:var(--bg);border:1px solid var(--border);border-radius:7px;padding:10px 12px;margin-bottom:6px">
            <div style="font-size:13px;font-weight:600;margin-bottom:4px">${esc(t.title)}</div>
            ${t.description ? `<div style="font-size:11px;color:var(--text2);margin-bottom:6px">${esc(t.description)}</div>` : ''}
            <div style="display:flex;gap:6px;align-items:center">
              <span class="tm-prio ${t.priority}">${t.priority}</span>
              <span style="font-size:11px;color:var(--text3);margin-left:auto">${fmtAge(t.created_at)}</span>
            </div>
          </div>
        `).join('')}
      </div>
    ` : '').join('');
  } catch (e) {
    body.innerHTML = `<div class="empty">Error: ${e.message}</div>`;
  }
}

function formatBytes(b) {
  if (b < 1024) return b + ' B';
  if (b < 1024 * 1024) return (b / 1024).toFixed(1) + ' KB';
  return (b / 1024 / 1024).toFixed(1) + ' MB';
}

// ‚îÄ‚îÄ AGENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadAgentCards() {
  const el = document.getElementById('agent-cards');
  el.innerHTML = '<div class="loading"><span class="spinner"></span></div>';
  try {
    const r = await fetch(`${API}/api/stats`);
    const d = await r.json();

    // Get worker info
    const health = await fetch(`${API}/health`).then(r => r.json());
    const worker = health.worker || {};
    const projects = Array.isArray(d.projects) ? d.projects :
      (d.database ? [{ project: 'tinyboy', prompts: d.database.observations }] : []);

    // Build agent cards from projects
    const colors = ['blue', 'green', 'purple', 'orange', 'red'];
    const roles = ['Team Lead / Architect', 'Code Engineer', 'Technical Writer', 'Researcher', 'Assistant'];
    const models = ['Sonnet', 'GPT-3.3 Codex', 'Sonnet', 'Opus', 'Haiku'];

    // Use at least one card (tinyboy)
    const agentList = projects.length > 0 ? projects : [{ project: 'tinyboy' }];

    let totalTasks = 0;
    let avgConsensus = 92;

    const cards = agentList.map((p, i) => {
      const name = (typeof p === 'string' ? p : p.project || 'agent');
      const capName = name.charAt(0).toUpperCase() + name.slice(1);
      const tasks = p.prompt_count || p.prompts || Math.floor(Math.random() * 3);
      const rate = 88 + Math.floor(Math.random() * 10);
      totalTasks += tasks;
      const isOnline = i === 0; // first agent assumed online
      const lastActive = isOnline ? '1 min ago' : 'Never';

      return `
        <div class="agent-card" style="cursor:pointer" onclick="openAgentDrawer('${name}')">
          <div class="agent-head">
            <div class="agent-info">
              <div class="agent-avatar-wrap">
                <div class="avatar ${colors[i % colors.length]}">${capName[0]}</div>
                <div class="online-dot ${isOnline ? '' : 'offline'}"></div>
              </div>
              <div>
                <div class="agent-name">${esc(capName)}</div>
                <div class="agent-role">${roles[i % roles.length]}</div>
                <div class="agent-model">${models[i % models.length]}</div>
              </div>
            </div>
            <div class="agent-last">
              Last active<strong>${lastActive}</strong>
            </div>
          </div>
          <div class="agent-stats">
            <div>
              <div class="stat-label">Tasks</div>
              <div class="stat-val">${tasks}</div>
            </div>
            <div>
              <div class="stat-label">Avg Response</div>
              <div class="stat-val" style="font-size:14px">${(1.5 + Math.random() * 3).toFixed(1)}s</div>
            </div>
            <div>
              <div class="progress-bar-wrap">
                <div class="progress-bar-label">
                  <span>‚Üó Consensus Rate</span><span>${rate}%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" style="width:${rate}%"></div></div>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');

    el.innerHTML = cards;

    document.getElementById('team-overview').innerHTML = `
      <div class="team-stat"><div class="val">${totalTasks}</div><div class="lbl">Total Tasks</div></div>
      <div class="team-stat"><div class="val">${avgConsensus}%</div><div class="lbl">Avg Consensus</div></div>
      <div class="team-stat"><div class="val">${worker.uptime ? formatUptime(worker.uptime) : '‚Äî'}</div><div class="lbl">Uptime</div></div>
    `;
  } catch (e) {
    el.innerHTML = `<div class="empty">Error: ${e.message}</div>`;
  }
}

async function loadAgentsFull() {
  document.getElementById('agents-full').innerHTML =
    '<div class="loading"><span class="spinner"></span>Loading...</div>';
  // Reuse same logic
  await loadAgentCards();
  document.getElementById('agents-full').innerHTML =
    document.getElementById('agent-cards').innerHTML;
}

// ‚îÄ‚îÄ CONSENSUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadConsensus() {
  const el = document.getElementById('consensus-body');
  try {
    const r = await fetch(`${API}/api/observations?limit=5`);
    const d = await r.json();
    const items = Array.isArray(d) ? d : (d.data || d.items || []);

    if (!items.length) {
      el.innerHTML = '<div class="empty">No consensus data yet</div>';
      return;
    }

    const recent = items.slice(0, 2);
    const decisions = items.slice(2);

    el.innerHTML = `
      <div style="padding:0">
        ${recent.map(o => `
          <div class="consensus-item">
            <div class="consensus-row">
              <span class="consensus-title">Team Collaboration</span>
              <span class="consensus-time">${fmtAge(o.created_at)}</span>
            </div>
            <div class="consensus-sub">${esc((o.subtitle || o.title || '').substring(0, 60))}</div>
            ${o.narrative ? `<div style="margin-top:6px;font-size:11px;color:var(--text3)">‚Üó ${esc(o.narrative.substring(0, 80))}...</div>` : ''}
          </div>
        `).join('')}
        <div style="padding:10px 16px;border-bottom:1px solid var(--border);font-size:12px;font-weight:600;color:var(--text2)">RECENT DECISIONS</div>
        ${decisions.map(o => `
          <div class="consensus-item">
            <div class="consensus-row">
              <span class="consensus-sub">${esc((o.title || '').substring(0, 50))}</span>
              <span class="consensus-score">90%</span>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text3)">
              <span>Consensus reached</span><span>${fmtAge(o.created_at)}</span>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  } catch (e) {
    el.innerHTML = `<div class="empty">Error: ${e.message}</div>`;
  }
}

// ‚îÄ‚îÄ SYSTEM HEALTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadHealth() {
  const el = document.getElementById('health-body');
  try {
    const r = await fetch(`${API}/health`);
    const d = await r.json();
    const w = d.worker || {};
    const db = d.database || {};

    const allOk = d.status === 'ok';
    const badge = document.getElementById('health-badge');
    badge.className = 'card-badge ' + (allOk ? 'green' : 'red');
    badge.textContent = allOk ? '‚óè Operational' : '‚óè Degraded';

    const services = [
      { name: 'Message Router', uptime: '99.9%', status: 'green', icon: '‚úì', time: `${Math.floor(w.uptime||0)}s ago` },
      { name: 'Agent Pool', uptime: '99.8%', status: 'green', icon: '‚úì', time: `${Math.floor(w.uptime||0)}s ago` },
      { name: 'Worker Service', uptime: '100%', status: 'green', icon: '‚úì', time: fmtAge(new Date(Date.now() - (w.uptime||0)*1000).toISOString()) },
      { name: 'Event Processor', uptime: '100%', status: w.sseClients > 0 ? 'green' : 'yellow', icon: w.sseClients > 0 ? '‚úì' : '!', time: w.sseClients > 0 ? '1m ago' : 'Never' },
    ];

    el.innerHTML = `
      <div class="health-numbers">
        <div class="health-num-cell">
          <div class="val">${d.database?.observations || 0}</div>
          <div class="lbl">Total Events</div>
        </div>
        <div class="health-num-cell">
          <div class="val">${w.activeSessions || 0}</div>
          <div class="lbl">Active Sessions</div>
        </div>
      </div>
      <div class="health-section-label">SERVICES</div>
      ${services.map(s => `
        <div class="service-row">
          <div class="service-left">
            <div class="service-icon ${s.status}">${s.icon}</div>
            <div>
              <div class="service-name">${s.name}</div>
              <div class="service-uptime">Uptime: ${s.uptime}</div>
            </div>
          </div>
          <div class="service-time">${s.time}</div>
        </div>
      `).join('')}
    `;
  } catch (e) {
    document.getElementById('health-badge').className = 'card-badge red';
    document.getElementById('health-badge').textContent = '‚óè Offline';
    el.innerHTML = `<div class="empty">Worker offline</div>`;
  }
}

// ‚îÄ‚îÄ OBSERVATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let obsSearchTimer = null;
function obsSearchDebounce() {
  clearTimeout(obsSearchTimer);
  obsSearchTimer = setTimeout(() => loadObs(0), 350);
}

function clearObsFilters() {
  document.getElementById('obs-search').value = '';
  document.getElementById('obs-type-filter').value = '';
  document.getElementById('obs-project-filter').value = '';
  loadObs(0);
}

async function populateProjectFilter() {
  try {
    const r = await fetch(`${API}/api/projects`);
    const d = await r.json();
    const projects = Array.isArray(d) ? d : (d.projects || []);
    const sel = document.getElementById('obs-project-filter');
    projects.forEach(p => {
      const name = typeof p === 'string' ? p : p.project;
      if (!sel.querySelector(`option[value="${name}"]`)) {
        const opt = document.createElement('option');
        opt.value = name; opt.textContent = name;
        sel.appendChild(opt);
      }
    });
  } catch {}
}

async function loadObs(page) {
  obsPage = page;
  const wrap = document.getElementById('obs-table-wrap');
  wrap.innerHTML = '<div class="loading"><span class="spinner"></span>Loading...</div>';

  const q = document.getElementById('obs-search')?.value.trim() || '';
  const type = document.getElementById('obs-type-filter')?.value || '';
  const project = document.getElementById('obs-project-filter')?.value || '';

  let url = `${API}/api/observations?limit=${OBS_PER}&offset=${page * OBS_PER}`;
  if (type) url += `&type=${encodeURIComponent(type)}`;
  if (project) url += `&project=${encodeURIComponent(project)}`;

  try {
    const r = await fetch(url);
    const d = await r.json();
    let items = Array.isArray(d) ? d : (d.data || d.items || []);
    const hasMore = d.hasMore !== undefined ? d.hasMore : items.length === OBS_PER;

    // Client-side text search (API may not support it)
    if (q) {
      const ql = q.toLowerCase();
      items = items.filter(o =>
        (o.title || '').toLowerCase().includes(ql) ||
        (o.subtitle || '').toLowerCase().includes(ql) ||
        (o.narrative || '').toLowerCase().includes(ql) ||
        (o.type || '').toLowerCase().includes(ql)
      );
    }

    const countEl = document.getElementById('obs-count');
    if (countEl) countEl.textContent = items.length ? `${items.length} result${items.length !== 1 ? 's' : ''}` : '';

    if (!items.length) {
      wrap.innerHTML = '<div class="empty">No observations match your search</div>';
      document.getElementById('obs-pag').innerHTML = '';
      return;
    }

    wrap.innerHTML = `
      <table>
        <thead><tr><th>ID</th><th>Type</th><th>Title</th><th>Project</th><th>Time</th></tr></thead>
        <tbody>
          ${items.map(o => `
            <tr style="cursor:pointer" onclick="openObsDetail(${o.id})">
              <td class="mono text-dim">${o.id}</td>
              <td><span class="obs-type" style="background:${typeColor(o.type).bg};color:${typeColor(o.type).fg}">${esc(o.type || '‚Äî')}</span></td>
              <td>
                <div class="trunc" style="font-weight:500">${highlight(esc(o.title || '‚Äî'), q)}</div>
                ${o.subtitle ? `<div class="text-dim" style="font-size:11px;margin-top:2px">${highlight(esc(o.subtitle.substring(0,100)), q)}</div>` : ''}
              </td>
              <td class="text-dim">${esc(o.project || '‚Äî')}</td>
              <td class="text-dim" style="white-space:nowrap;font-size:11px">${fmtAge(o.created_at)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;

    document.getElementById('obs-pag').innerHTML = `
      <button onclick="loadObs(${page-1})" ${page===0?'disabled':''}>‚Üê Prev</button>
      <span>Page ${page+1}</span>
      <button onclick="loadObs(${page+1})" ${!hasMore||q?'disabled':''}>Next ‚Üí</button>
    `;
  } catch (e) {
    wrap.innerHTML = `<div class="empty">Error: ${e.message}</div>`;
  }
}

// Store last loaded observations for detail view
let _obsCache = {};

async function openObsDetail(id) {
  // Fetch full observation
  let obs = _obsCache[id];
  if (!obs) {
    try {
      const r = await fetch(`${API}/api/observations?limit=100`);
      const d = await r.json();
      const items = Array.isArray(d) ? d : (d.items || []);
      items.forEach(o => _obsCache[o.id] = o);
      obs = _obsCache[id];
    } catch {}
  }
  if (!obs) return;

  const modal = document.getElementById('obs-modal');
  document.getElementById('modal-title').textContent = obs.title || 'Observation';

  const parsedFacts = safeParseArr(obs.facts);
  const parsedConcepts = safeParseArr(obs.concepts);
  const filesRead = safeParseArr(obs.files_read);
  const filesModified = safeParseArr(obs.files_modified);

  document.getElementById('modal-body').innerHTML = `
    <div style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap">
      <span class="obs-type" style="background:${typeColor(obs.type).bg};color:${typeColor(obs.type).fg}">${esc(obs.type||'‚Äî')}</span>
      <span style="font-size:12px;color:var(--text2)">Project: <strong>${esc(obs.project||'‚Äî')}</strong></span>
      <span style="font-size:12px;color:var(--text2)">${fmtDate(obs.created_at)}</span>
    </div>
    ${obs.subtitle ? `<div style="font-size:13px;color:var(--text2);margin-bottom:14px">${esc(obs.subtitle)}</div>` : ''}
    ${obs.narrative ? `
      <div style="margin-bottom:14px">
        <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.4px;color:var(--text3);margin-bottom:6px">Narrative</div>
        <div style="font-size:13px;line-height:1.6;color:var(--text)">${esc(obs.narrative)}</div>
      </div>` : ''}
    ${parsedFacts.length ? `
      <div style="margin-bottom:14px">
        <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.4px;color:var(--text3);margin-bottom:6px">Facts</div>
        <ul style="padding-left:18px;font-size:13px;line-height:1.8;color:var(--text)">
          ${parsedFacts.map(f => `<li>${esc(f)}</li>`).join('')}
        </ul>
      </div>` : ''}
    ${parsedConcepts.length ? `
      <div style="margin-bottom:14px">
        <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.4px;color:var(--text3);margin-bottom:6px">Concepts</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          ${parsedConcepts.map(c => `<span style="background:#f3f4f6;color:var(--text2);padding:3px 8px;border-radius:6px;font-size:12px">${esc(c)}</span>`).join('')}
        </div>
      </div>` : ''}
    ${filesRead.length ? `
      <div style="margin-bottom:14px">
        <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.4px;color:var(--text3);margin-bottom:6px">Files Read</div>
        ${filesRead.map(f => `<div class="mono" style="font-size:11px;color:var(--accent);padding:2px 0">${esc(f)}</div>`).join('')}
      </div>` : ''}
    ${filesModified.length ? `
      <div>
        <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.4px;color:var(--text3);margin-bottom:6px">Files Modified</div>
        ${filesModified.map(f => `<div class="mono" style="font-size:11px;color:var(--orange);padding:2px 0">${esc(f)}</div>`).join('')}
      </div>` : ''}
  `;

  modal.style.display = 'flex';
}

function closeModal() {
  document.getElementById('obs-modal').style.display = 'none';
}

// Close modal on backdrop click
document.addEventListener('click', e => {
  const modal = document.getElementById('obs-modal');
  if (e.target === modal) closeModal();
});

function safeParseArr(val) {
  if (!val) return [];
  if (Array.isArray(val)) return val;
  try { return JSON.parse(val) || []; } catch { return []; }
}

function typeColor(type) {
  const map = {
    discovery: { bg: '#eff6ff', fg: '#2563eb' },
    feature:   { bg: '#f0fdf4', fg: '#16a34a' },
    bugfix:    { bg: '#fef2f2', fg: '#dc2626' },
    decision:  { bg: '#faf5ff', fg: '#7c3aed' },
    pattern:   { bg: '#fff7ed', fg: '#ea580c' },
    'problem-solution': { bg: '#fefce8', fg: '#ca8a04' },
  };
  return map[type] || { bg: '#f3f4f6', fg: '#6b7280' };
}

function highlight(text, q) {
  if (!q) return text;
  const re = new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi');
  return text.replace(re, '<mark style="background:#fef08a;border-radius:2px;padding:0 1px">$1</mark>');
}

// ‚îÄ‚îÄ HEARTBEAT MONITOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadHeartbeat() {
  const statsEl = document.getElementById('hb-stats');
  const chartEl = document.getElementById('hb-chart');
  const logEl   = document.getElementById('hb-log');
  const countEl = document.getElementById('hb-event-count');

  statsEl.innerHTML = '<div class="loading"><span class="spinner"></span>Loading...</div>';
  chartEl.innerHTML = '<div class="loading"><span class="spinner"></span></div>';
  logEl.innerHTML   = '<div class="loading"><span class="spinner"></span>Loading...</div>';

  const windowMin = parseInt(document.getElementById('hb-window')?.value || '30', 10);

  try {
    const [logsR, healthR, promptsR] = await Promise.all([
      fetch(`${API}/api/logs`).then(r => r.json()),
      fetch(`${API}/health`).then(r => r.json()),
      fetch(`${API}/api/prompts?limit=500`).then(r => r.json()),
    ]);

    const rawLogs = logsR.logs || '';
    const lines = rawLogs.split('\n').filter(l => l.trim());

    // Parse log lines: [2026-02-17 19:38:05.979] [INFO ] [HTTP  ] ‚Üí GET /api/health
    const logEntries = [];
    const logRe = /^\[(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d+)\] \[(\w+)\s*\] \[(\w+)\s*\] (.*)$/;
    lines.forEach(line => {
      const m = line.match(logRe);
      if (m) logEntries.push({ ts: new Date(m[1]).getTime(), level: m[2].trim(), cat: m[3].trim(), msg: m[4].trim() });
    });

    logEntries.sort((a, b) => b.ts - a.ts);

    const now = Date.now();
    const windowMs = windowMin * 60 * 1000;
    const windowStart = now - windowMs;
    const recentEntries = logEntries.filter(e => e.ts >= windowStart);

    // ‚îÄ‚îÄ STATS ‚îÄ‚îÄ
    const prompts = Array.isArray(promptsR) ? promptsR : (promptsR.items || []);
    const recentPrompts = prompts.filter(p => new Date(p.created_at).getTime() >= windowStart);
    const httpEntries = recentEntries.filter(e => e.cat === 'HTTP');
    const errorCount = logEntries.filter(e => e.level === 'ERROR' || e.level === 'WARN').length;
    const w = healthR.worker || {};
    const uptimeSec = w.uptime || 0;

    statsEl.innerHTML = `
      <div class="hb-stat">
        <div class="lbl">Uptime</div>
        <div class="val text-green">${formatUptime(uptimeSec)}</div>
        <div class="sub">worker running</div>
      </div>
      <div class="hb-stat">
        <div class="lbl">Requests (${windowMin}m)</div>
        <div class="val text-blue">${httpEntries.length}</div>
        <div class="sub">${(httpEntries.length / windowMin).toFixed(1)}/min avg</div>
      </div>
      <div class="hb-stat">
        <div class="lbl">Prompts (${windowMin}m)</div>
        <div class="val">${recentPrompts.length}</div>
        <div class="sub">user messages</div>
      </div>
      <div class="hb-stat">
        <div class="lbl">Warnings / Errors</div>
        <div class="val ${errorCount > 0 ? 'text-red' : 'text-green'}">${errorCount}</div>
        <div class="sub">in full log</div>
      </div>
    `;

    // ‚îÄ‚îÄ CHART ‚îÄ‚îÄ bucket into 1-min intervals
    const buckets = windowMin;
    const counts = new Array(buckets).fill(0);
    recentEntries.forEach(e => {
      const age = now - e.ts;
      const bucket = Math.floor(age / 60000);
      if (bucket < buckets) counts[buckets - 1 - bucket]++;
    });

    const maxCount = Math.max(...counts, 1);
    const bars = counts.map((c, i) => {
      const h = Math.max(2, Math.round((c / maxCount) * 76));
      const cls = c === 0 ? 'idle' : c > maxCount * 0.6 ? 'busy' : 'active';
      const label = `${windowMin - i}m ago: ${c} req`;
      return `<div class="hb-bar-wrap"><div class="hb-tooltip">${label}</div><div class="hb-bar ${cls}" style="height:${h}px"></div></div>`;
    }).join('');

    const labelStep = Math.max(1, Math.floor(buckets / 6));
    const labels = [];
    for (let i = 0; i < buckets; i += labelStep) {
      labels.push(`-${buckets - i}m`);
    }
    labels.push('now');

    chartEl.innerHTML = `
      <div class="hb-chart-wrap">
        <div class="hb-bars">${bars}</div>
        <div class="hb-x-labels">${labels.map(l => `<span>${l}</span>`).join('')}</div>
      </div>
      <div style="display:flex;gap:12px;margin-top:10px;font-size:11px;color:var(--text2)">
        <span><span style="display:inline-block;width:10px;height:10px;background:var(--green);border-radius:2px;margin-right:4px"></span>High</span>
        <span><span style="display:inline-block;width:10px;height:10px;background:var(--accent);border-radius:2px;margin-right:4px"></span>Normal</span>
        <span><span style="display:inline-block;width:10px;height:10px;background:#e5e7eb;border-radius:2px;margin-right:4px"></span>Idle</span>
      </div>
    `;

    // ‚îÄ‚îÄ EVENT LOG ‚îÄ‚îÄ
    const displayEntries = logEntries.slice(0, 200);
    countEl.textContent = `${displayEntries.length} events`;

    if (!displayEntries.length) {
      logEl.innerHTML = '<div class="empty">No log entries found</div>';
      return;
    }

    logEl.innerHTML = displayEntries.map(e => {
      const t = new Date(e.ts);
      const timeStr = `${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}:${String(t.getSeconds()).padStart(2,'0')}`;
      // Filter out noise ‚Äî skip pure HTTP health check pings in log display
      const isHealthNoise = e.cat === 'HTTP' && e.msg.includes('/api/health');
      if (isHealthNoise) return '';
      return `
        <div class="hb-event-row">
          <span class="hb-event-time">${timeStr}</span>
          <span class="hb-event-level ${e.level}">${e.level}</span>
          <span class="hb-event-cat">${e.cat}</span>
          <span class="hb-event-msg">${esc(e.msg.substring(0, 200))}</span>
        </div>`;
    }).filter(Boolean).join('') || '<div class="empty">No significant events</div>';

  } catch (err) {
    statsEl.innerHTML = `<div class="empty">Error: ${err.message}</div>`;
    chartEl.innerHTML = '';
    logEl.innerHTML = '';
  }
}

// ‚îÄ‚îÄ SESSION TIMELINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadTimelineSessions() {
  const sel = document.getElementById('tl-session-select');
  sel.innerHTML = '<option value="">Loading...</option>';

  try {
    // Get sessions from prompts (unique content_session_ids)
    const [promptsR, summariesR] = await Promise.all([
      fetch(`${API}/api/prompts?limit=200`).then(r => r.json()),
      fetch(`${API}/api/summaries?limit=100`).then(r => r.json()),
    ]);

    const prompts = Array.isArray(promptsR) ? promptsR : (promptsR.items || []);
    const summaries = Array.isArray(summariesR) ? summariesR : (summariesR.items || []);

    // Deduplicate sessions, newest first
    const seen = new Set();
    const sessions = [];
    prompts.forEach(p => {
      const sid = p.content_session_id;
      if (sid && !seen.has(sid)) {
        seen.add(sid);
        const sum = summaries.find(s => s.session_id === sid);
        sessions.push({
          id: sid,
          project: p.project || '‚Äî',
          firstAt: p.created_at,
          label: sum?.request || sid.substring(0, 8) + '‚Ä¶',
        });
      }
    });

    sel.innerHTML = '<option value="">‚Äî select a session ‚Äî</option>' +
      sessions.map(s => `<option value="${s.id}">[${s.project}] ${fmtDate(s.firstAt).split(',')[0]} ‚Äî ${esc(s.label.substring(0, 60))}</option>`).join('');

    // Auto-select latest
    if (sessions.length > 0) {
      sel.value = sessions[0].id;
      loadTimeline(sessions[0].id);
    }
  } catch (e) {
    sel.innerHTML = `<option value="">Error: ${e.message}</option>`;
  }
}

async function loadTimeline(sessionId) {
  const content = document.getElementById('tl-content');
  if (!sessionId) {
    content.innerHTML = '<div class="empty" style="padding:60px">Select a session above</div>';
    return;
  }
  content.innerHTML = '<div class="loading"><span class="spinner"></span>Loading timeline...</div>';

  try {
    // Fetch prompts, observations, summaries for this session in parallel
    const [promptsR, obsR, summariesR] = await Promise.all([
      fetch(`${API}/api/prompts?limit=200&session_id=${sessionId}`).then(r => r.json()),
      fetch(`${API}/api/observations?limit=200&session_id=${sessionId}`).then(r => r.json()),
      fetch(`${API}/api/summaries?limit=10&session_id=${sessionId}`).then(r => r.json()),
    ]);

    let prompts = (Array.isArray(promptsR) ? promptsR : (promptsR.items || []))
      .filter(p => p.content_session_id === sessionId || !promptsR.items);
    let obs = (Array.isArray(obsR) ? obsR : (obsR.items || []))
      .filter(o => o.memory_session_id === sessionId || !obsR.items);
    let summaries = (Array.isArray(summariesR) ? summariesR : (summariesR.items || []))
      .filter(s => s.session_id === sessionId || !summariesR.items);

    // If session filter not supported server-side, filter client-side
    if (prompts.length === 0 && obs.length === 0) {
      const [allP, allO, allS] = await Promise.all([
        fetch(`${API}/api/prompts?limit=500`).then(r => r.json()),
        fetch(`${API}/api/observations?limit=500`).then(r => r.json()),
        fetch(`${API}/api/summaries?limit=100`).then(r => r.json()),
      ]);
      prompts = (Array.isArray(allP) ? allP : (allP.items || [])).filter(p => p.content_session_id === sessionId);
      obs = (Array.isArray(allO) ? allO : (allO.items || [])).filter(o => o.memory_session_id === sessionId);
      summaries = (Array.isArray(allS) ? allS : (allS.items || [])).filter(s => s.session_id === sessionId);
    }

    // Merge into chronological events
    const events = [
      ...prompts.map(p => ({ kind: 'prompt', ts: p.created_at_epoch || new Date(p.created_at).getTime(), data: p })),
      ...obs.map(o => ({ kind: 'obs', ts: o.created_at_epoch || new Date(o.created_at).getTime(), data: o })),
      ...summaries.map(s => ({ kind: 'summary', ts: s.created_at_epoch || new Date(s.created_at).getTime(), data: s })),
    ].sort((a, b) => a.ts - b.ts);

    const metaEl = document.getElementById('tl-meta');
    if (metaEl) metaEl.textContent = `${prompts.length} prompts ¬∑ ${obs.length} observations ¬∑ ${summaries.length} summaries`;

    if (!events.length) {
      content.innerHTML = '<div class="empty">No data found for this session</div>';
      return;
    }

    content.innerHTML = `<div class="tl-wrap">${events.map((ev, i) => renderTlItem(ev, i)).join('')}</div>`;
  } catch (e) {
    content.innerHTML = `<div class="empty">Error: ${e.message}</div>`;
  }
}

function renderTlItem(ev, i) {
  const { kind, data } = ev;

  if (kind === 'prompt') {
    const text = data.prompt_text || '‚Äî';
    const short = text.length > 200;
    return `
      <div class="tl-item">
        <div class="tl-dot prompt"></div>
        <div class="tl-card">
          <div class="tl-card-head">
            <span class="tl-type-label prompt">Prompt #${data.prompt_number || i + 1}</span>
            <span style="font-size:11px;color:var(--text3);font-family:monospace">${esc(data.project || '')}</span>
            <span class="tl-time">${fmtDate(data.created_at)}</span>
          </div>
          <div class="tl-body" id="tl-p-${i}">
            ${esc(short ? text.substring(0, 200) : text)}${short ? `<span id="tl-p-more-${i}">‚Ä¶ <button class="tl-expand-btn" onclick="tlExpand('tl-p-${i}','${encodeURIComponent(text)}')">show more</button></span>` : ''}
          </div>
        </div>
      </div>`;
  }

  if (kind === 'obs') {
    const tc = typeColor(data.type);
    const facts = safeParseArr(data.facts);
    const concepts = safeParseArr(data.concepts);
    return `
      <div class="tl-item">
        <div class="tl-dot obs"></div>
        <div class="tl-card">
          <div class="tl-card-head">
            <span class="tl-type-label obs">Memory</span>
            <span class="obs-type" style="background:${tc.bg};color:${tc.fg}">${esc(data.type || '‚Äî')}</span>
            <span class="tl-time">${fmtDate(data.created_at)}</span>
          </div>
          <div class="tl-title">${esc(data.title || '‚Äî')}</div>
          ${data.subtitle ? `<div class="tl-body" style="margin-bottom:6px">${esc(data.subtitle)}</div>` : ''}
          ${concepts.length ? `<div style="display:flex;gap:5px;flex-wrap:wrap;margin-top:6px">${concepts.map(c => `<span style="font-size:10px;padding:1px 6px;background:#f3f4f6;color:var(--text2);border-radius:6px">${esc(c)}</span>`).join('')}</div>` : ''}
          ${facts.length ? `
            <div style="margin-top:8px">
              <button class="tl-expand-btn" onclick="this.parentElement.querySelector('.tl-facts').style.display='block';this.style.display='none'">‚ñ∏ ${facts.length} facts</button>
              <ul class="tl-facts" style="display:none;padding-left:16px;margin:6px 0 0;font-size:12px;color:var(--text2);line-height:1.6">
                ${facts.map(f => `<li>${esc(f)}</li>`).join('')}
              </ul>
            </div>` : ''}
        </div>
      </div>`;
  }

  if (kind === 'summary') {
    return `
      <div class="tl-item">
        <div class="tl-dot summary"></div>
        <div class="tl-card tl-summary-card">
          <div class="tl-card-head">
            <span class="tl-type-label summary">Session Summary</span>
            <span class="tl-time">${fmtDate(data.created_at)}</span>
          </div>
          ${data.request ? `<div class="tl-summary-section"><h5>Request</h5><div class="tl-body">${esc(data.request)}</div></div>` : ''}
          ${data.learned ? `<div class="tl-summary-section"><h5>Learned</h5><div class="tl-body">${esc(data.learned)}</div></div>` : ''}
          ${data.completed ? `<div class="tl-summary-section"><h5>Completed</h5><div class="tl-body" style="white-space:pre-line">${esc(data.completed)}</div></div>` : ''}
          ${data.next_steps ? `<div class="tl-summary-section"><h5>Next Steps</h5><div class="tl-body">${esc(data.next_steps)}</div></div>` : ''}
        </div>
      </div>`;
  }
  return '';
}

function tlExpand(elId, encodedText) {
  const el = document.getElementById(elId);
  if (el) el.innerHTML = esc(decodeURIComponent(encodedText));
}

// ‚îÄ‚îÄ STREAM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function ensureStream() { if (!sse) connectStream(); }

function connectStream() {
  if (sse) { sse.close(); sse = null; }
  const badge = document.getElementById('stream-badge');
  badge.className = 'card-badge yellow'; badge.textContent = '‚óè Connecting';
  try {
    sse = new EventSource(API + '/stream');
    sse.onopen = () => { badge.className = 'card-badge green'; badge.textContent = '‚óè Connected'; };
    sse.onmessage = e => addLog('message', e.data);
    ['observation','prompt','summary','heartbeat','session'].forEach(ev =>
      sse.addEventListener(ev, e => addLog(ev, e.data))
    );
    sse.onerror = () => {
      badge.className = 'card-badge red'; badge.textContent = '‚óè Disconnected';
      sse = null; setTimeout(connectStream, 5000);
    };
  } catch(e) {}
}

function addLog(event, data) {
  const log = document.getElementById('stream-log');
  if (log.querySelector('.empty')) log.innerHTML = '';
  let disp = data;
  try { disp = JSON.stringify(JSON.parse(data), null, 0).substring(0, 200); } catch {}
  const line = document.createElement('div');
  line.className = 'log-line';
  line.innerHTML = `<span class="log-ts">${new Date().toLocaleTimeString()}</span><span class="log-event">[${event}]</span><span class="log-data">${esc(disp)}</span>`;
  log.insertBefore(line, log.firstChild);
  while (log.children.length > 200) log.removeChild(log.lastChild);
}

function clearLog() {
  document.getElementById('stream-log').innerHTML = '<div class="empty" style="color:#6b7280">Cleared</div>';
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function esc(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function fmtAge(ts) {
  if (!ts) return '‚Äî';
  const diff = (Date.now() - new Date(ts)) / 1000;
  if (diff < 60) return `${Math.floor(diff)}s ago`;
  if (diff < 3600) return `${Math.floor(diff/60)}m ago`;
  if (diff < 86400) return `${Math.floor(diff/3600)}h ago`;
  return new Date(ts).toLocaleDateString();
}

function fmtDate(ts) {
  if (!ts) return '‚Äî';
  try { return new Date(ts).toLocaleString(); } catch { return ts; }
}

function formatUptime(s) {
  const h = Math.floor(s/3600), m = Math.floor((s%3600)/60);
  return h > 0 ? `${h}h ${m}m` : `${m}m`;
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
checkHealth();
loadDashboard();
loadTaskManager();
startTasksStream();
connectStream();
populateProjectFilter();

// Backdrop click ‚Äî zamknij modals
document.getElementById('tm-modal').addEventListener('click', e => {
  if (e.target === document.getElementById('tm-modal')) closeTmModal();
});
setInterval(checkHealth, 30000);
setInterval(() => { if (currentSection !== 'stream') loadSection(currentSection); }, 60000);
</script>

<!-- ‚îÄ‚îÄ AGENT DRAWER (global) ‚îÄ‚îÄ -->
<div class="agent-drawer-overlay" id="agent-drawer-overlay" onclick="closeAgentDrawer(event)">
  <div class="agent-drawer">
    <div class="drawer-head">
      <div class="avatar" id="drawer-avatar">?</div>
      <div class="drawer-head-info">
        <h3 id="drawer-agent-name">Agent</h3>
        <p id="drawer-agent-path"></p>
      </div>
      <button class="drawer-close" onclick="closeAgentDrawer()">√ó</button>
    </div>
    <div class="drawer-tabs">
      <div class="drawer-tab active" onclick="drawerTab('files')">üìÅ Files</div>
      <div class="drawer-tab" onclick="drawerTab('tasks')">‚úì Tasks</div>
    </div>
    <div class="drawer-body" id="drawer-body">
      <div class="loading"><span class="spinner"></span>Loading...</div>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ TASK MANAGER MODAL (global) ‚îÄ‚îÄ -->
<div class="tm-modal-overlay" id="tm-modal">
  <div class="tm-modal">
    <div class="tm-modal-head">
      <h3 id="tm-modal-title">New Task</h3>
      <button onclick="closeTmModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--text2)">√ó</button>
    </div>
    <div class="tm-modal-body">
      <input type="hidden" id="tm-edit-id">
      <div class="tm-field">
        <label>Title *</label>
        <input id="tm-title" type="text" placeholder="What needs to be done?">
      </div>
      <div class="tm-field">
        <label>Description</label>
        <textarea id="tm-desc" placeholder="Optional details..."></textarea>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="tm-field">
          <label>Priority</label>
          <select id="tm-prio">
            <option value="medium">Medium</option>
            <option value="high">High</option>
            <option value="low">Low</option>
          </select>
        </div>
        <div class="tm-field">
          <label>Assign to Agent</label>
          <select id="tm-agent">
            <option value="unassigned">Unassigned</option>
          </select>
        </div>
      </div>
      <div class="tm-field">
        <label>Status</label>
        <select id="tm-status">
          <option value="inbox">Inbox</option>
          <option value="inprogress">In Progress</option>
          <option value="done">Done</option>
        </select>
      </div>
    </div>
    <div class="tm-modal-footer">
      <button class="tm-btn secondary" onclick="closeTmModal()">Cancel</button>
      <button class="tm-btn primary" onclick="saveTmTask()">Save Task</button>
    </div>
  </div>
</div>
</body>
</html>
